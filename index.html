<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Field Attendance System</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ */
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  :root {
    --blue-dark:   #0a2540;
    --blue-mid:    #1a4b8c;
    --blue:        #2563eb;
    --blue-light:  #dbeafe;
    --green:       #059669;
    --green-light: #d1fae5;
    --white:       #ffffff;
    --bg:          #f1f5f9;
    --text:        #0f172a;
    --text-mid:    #475569;
    --text-soft:   #94a3b8;
    --border:      #e2e8f0;
    --radius:      14px;
    --radius-sm:   8px;
    --font:        'Inter', sans-serif;
  }

  body {
    font-family: var(--font);
    font-size: 14px;
    color: var(--text);
    background: var(--bg);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-mid) 55%, var(--blue) 100%);
    padding: 16px 16px 0;
    position: relative; overflow: hidden;
  }
  .header::after {
    content: '';
    position: absolute; top: -50px; right: -50px;
    width: 160px; height: 160px;
    background: rgba(16,185,129,0.12);
    border-radius: 50%;
  }
  .header-row {
    display: flex; align-items: center; gap: 12px;
    position: relative; z-index: 1;
  }
  .logo {
    width: 44px; height: 44px; flex-shrink: 0;
    background: linear-gradient(135deg, #10b981, #059669);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    box-shadow: 0 3px 10px rgba(16,185,129,0.35);
  }
  .header-text h1 {
    font-size: 18px; font-weight: 700;
    color: #fff; letter-spacing: -0.2px;
  }
  .header-text p {
    font-size: 11px; font-weight: 500;
    color: rgba(255,255,255,0.6);
    text-transform: uppercase; letter-spacing: 0.8px;
    margin-top: 1px;
  }
  .dt-bar {
    display: flex; gap: 18px;
    padding: 10px 0 14px;
    position: relative; z-index: 1;
  }
  .dt-bar span {
    font-size: 13px; font-weight: 500;
    color: rgba(255,255,255,0.85);
  }

  /* ‚îÄ‚îÄ LOCATION BANNER (top of page) ‚îÄ‚îÄ */
  .loc-banner {
    display: flex; align-items: center; gap: 8px;
    padding: 9px 16px;
    font-size: 12px; font-weight: 500;
    background: #fef3c7; color: #92400e;
    border-bottom: 1px solid #fde68a;
  }
  .loc-banner.ok  { background: var(--green-light); color: #065f46; border-color: #a7f3d0; }
  .loc-banner.err { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
  .loc-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: currentColor; flex-shrink: 0;
    animation: blink 1.4s infinite;
  }
  .loc-banner.ok  .loc-dot,
  .loc-banner.err .loc-dot { animation: none; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.25} }

  /* ‚îÄ‚îÄ TAB NAV ‚îÄ‚îÄ */
  .tabs {
    display: flex;
    background: var(--white);
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 100;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  }
  .tab {
    flex: 1; padding: 13px 8px;
    border: none; background: none;
    font-family: var(--font);
    font-size: 13px; font-weight: 600;
    color: var(--text-soft); cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: color .18s, border-color .18s;
  }
  .tab.active { color: var(--blue); border-bottom-color: var(--blue); }

  /* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
  .section { display: none; padding: 16px 14px 90px; animation: fadeUp .25s ease; }
  .section.active { display: block; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

  /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
  .card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 14px;
    border: 1px solid var(--border);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .card-head {
    display: flex; align-items: center; gap: 10px;
    padding-bottom: 12px; margin-bottom: 14px;
    border-bottom: 1px solid var(--border);
  }
  .card-ico {
    width: 34px; height: 34px; border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 17px; flex-shrink: 0;
  }
  .ico-blue  { background: var(--blue-light); }
  .ico-green { background: var(--green-light); }
  .card-head-text .title    { font-size: 14px; font-weight: 600; color: var(--text); }
  .card-head-text .subtitle { font-size: 11px; font-weight: 400; color: var(--text-soft); margin-top: 1px; }

  /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
  .fg { margin-bottom: 12px; }
  .fg label {
    display: block;
    font-size: 12px; font-weight: 600;
    color: var(--text-mid);
    margin-bottom: 5px;
  }
  .fg label .req { color: var(--blue); }
  .fg label .opt { font-weight: 400; color: var(--text-soft); font-size: 11px; }
  input.fi {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: var(--font);
    font-size: 14px; font-weight: 400;
    color: var(--text);
    background: var(--bg);
    outline: none;
    transition: border-color .15s, box-shadow .15s;
  }
  input.fi:focus { border-color: var(--blue); background: var(--white); box-shadow: 0 0 0 3px rgba(37,99,235,.1); }
  input.fi.ro    { background: var(--blue-light); color: var(--blue-dark); border-color: transparent; cursor: default; font-weight: 500; }

  /* ‚îÄ‚îÄ CAMERA ‚îÄ‚îÄ */
  .cam-wrap {
    border: 1.5px dashed var(--border);
    border-radius: var(--radius);
    overflow: hidden; background: #f8fafc;
    transition: border-color .2s;
  }
  .cam-wrap.live { border-color: #10b981; border-style: solid; }
  .cam-placeholder {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 28px 16px; gap: 8px; cursor: pointer;
  }
  .cam-placeholder .icon { font-size: 36px; }
  .cam-placeholder .lbl  { font-size: 13px; font-weight: 600; color: var(--text-mid); }
  .cam-placeholder .sub  { font-size: 11px; color: var(--text-soft); }
  video { width: 100%; display: block; background: #000; }
  .vp { height: 300px; object-fit: cover; }
  .vl { height: 210px; object-fit: cover; }
  .cam-ctrl {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 12px;
    background: rgba(10,37,64,.88);
  }
  .cbtn {
    border: none; border-radius: 7px; cursor: pointer;
    font-family: var(--font); font-weight: 600; font-size: 12px;
    padding: 8px 14px; transition: opacity .15s;
  }
  .cbtn:active { opacity: .8; }
  .cbtn-cap  { background: #10b981; color: #fff; padding: 9px 22px; border-radius: 50px; font-size: 13px; }
  .cbtn-sw   { background: rgba(255,255,255,.15); color: #fff; font-size: 15px; }
  .cbtn-ret  { background: rgba(255,255,255,.15); color: #fff; }
  .photo-wrap { position: relative; }
  .photo-wrap img { width: 100%; display: block; }
  .photo-badge {
    position: absolute; top: 8px; right: 8px;
    background: #10b981; color: #fff;
    padding: 3px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 600;
  }

  /* ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ */
  .submit-btn {
    width: 100%; padding: 14px;
    background: linear-gradient(135deg, var(--blue), var(--blue-mid));
    color: #fff; border: none; border-radius: var(--radius);
    font-family: var(--font); font-size: 15px; font-weight: 600;
    cursor: pointer; transition: opacity .2s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    box-shadow: 0 4px 14px rgba(37,99,235,.3);
  }
  .submit-btn:disabled { opacity: .55; cursor: not-allowed; }

  /* ‚îÄ‚îÄ SCORECARD ‚îÄ‚îÄ */
  .score-grid {
    display: grid; grid-template-columns: repeat(3,1fr); gap: 10px;
    margin-bottom: 14px;
  }
  .sc {
    background: var(--white); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 14px 8px; text-align: center;
  }
  .sc .num { font-size: 26px; font-weight: 700; line-height: 1; }
  .sc .num.p { color: var(--green); }
  .sc .num.n { color: var(--blue); }
  .sc .lbl   { font-size: 10px; font-weight: 600; color: var(--text-soft); margin-top: 4px; text-transform: uppercase; letter-spacing: .5px; }

  /* ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ */
  .filter-row { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .fbtn {
    padding: 6px 14px; border: 1.5px solid var(--border);
    border-radius: 50px; background: var(--white);
    font-family: var(--font); font-size: 12px; font-weight: 500;
    color: var(--text-mid); cursor: pointer; transition: all .15s;
  }
  .fbtn.active { background: var(--blue); color: #fff; border-color: var(--blue); }
  .crange { display: none; gap: 8px; align-items: center; width: 100%; margin-top: 6px; }
  .crange.show { display: flex; }
  .crange input { flex:1; padding:7px 10px; border:1.5px solid var(--border); border-radius:7px; font-family:var(--font); font-size:12px; }
  .crange button { padding:8px 14px; background:var(--blue); color:#fff; border:none; border-radius:7px; font-family:var(--font); font-size:12px; font-weight:600; cursor:pointer; }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .tbl-wrap { overflow-x: auto; border-radius: var(--radius-sm); border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; }
  th {
    background: var(--blue-dark);
    color: #fff; padding: 9px 10px;
    text-align: left; font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: .5px; white-space: nowrap;
  }
  td {
    padding: 9px 10px; border-bottom: 1px solid var(--border);
    font-size: 13px; font-weight: 400; color: var(--text);
    vertical-align: middle; white-space: nowrap;
  }
  tr:last-child td { border-bottom: none; }
  tr:nth-child(even) td { background: #f8fafc; }
  .badge {
    display: inline-block; padding: 2px 9px; border-radius: 20px;
    font-size: 11px; font-weight: 600;
  }
  .bp { background: var(--green-light); color: #065f46; }

  /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
  .empty {
    text-align: center; padding: 36px 16px; color: var(--text-soft);
  }
  .empty .ei { font-size: 40px; margin-bottom: 10px; }
  .empty p   { font-size: 13px; }

  .fp-note {
    display: flex; align-items: center; gap: 8px;
    background: var(--blue-light); border: 1px solid #bfdbfe;
    border-radius: var(--radius-sm); padding: 10px 12px;
    font-size: 12px; font-weight: 500; color: #1e40af;
    margin-bottom: 14px;
  }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .overlay {
    position: fixed; inset: 0;
    background: rgba(10,37,64,.55); backdrop-filter: blur(3px);
    z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px;
  }
  .overlay.show { display: flex; }
  .modal {
    background: var(--white); border-radius: 18px;
    padding: 24px 20px; max-width: 360px; width: 100%;
    box-shadow: 0 16px 48px rgba(0,0,0,.2);
    animation: pop .28s cubic-bezier(.34,1.56,.64,1);
  }
  @keyframes pop { from{opacity:0;transform:scale(.85)} to{opacity:1;transform:scale(1)} }
  .modal .m-icon  { font-size: 48px; text-align: center; }
  .modal .m-title { font-size: 18px; font-weight: 700; text-align: center; margin: 8px 0 16px; color: var(--text); }
  .m-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid var(--border);
  }
  .m-row:last-of-type { border: none; }
  .m-row .lbl { font-size: 11px; font-weight: 600; color: var(--text-soft); text-transform: uppercase; letter-spacing: .5px; }
  .m-row .val { font-size: 14px; font-weight: 600; color: var(--text); text-align: right; max-width: 200px; }
  .m-close {
    width: 100%; margin-top: 18px; padding: 12px;
    background: linear-gradient(135deg, #10b981, var(--green));
    color: #fff; border: none; border-radius: var(--radius-sm);
    font-family: var(--font); font-size: 14px; font-weight: 600;
    cursor: pointer; box-shadow: 0 4px 12px rgba(5,150,105,.3);
  }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast {
    position: fixed; bottom: 72px; left: 50%; transform: translateX(-50%);
    background: var(--blue-dark); color: #fff;
    padding: 9px 18px; border-radius: 50px;
    font-size: 13px; font-weight: 500; z-index: 300;
    opacity: 0; transition: opacity .25s; pointer-events: none; white-space: nowrap;
  }
  .toast.show { opacity: 1; }

  /* ‚îÄ‚îÄ SPINNER ‚îÄ‚îÄ */
  .spin {
    width: 18px; height: 18px;
    border: 2.5px solid rgba(255,255,255,.3);
    border-top-color: #fff; border-radius: 50%;
    animation: rot .6s linear infinite;
  }
  @keyframes rot { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-row">
    <div class="logo">‚ö°</div>
    <div class="header-text">
      <h1>Field Attendance</h1>
      <p>Site Check-In System</p>
    </div>
  </div>
  <div class="dt-bar">
    <span id="liveDate">--</span>
    <span>|</span>
    <span id="liveTime">--</span>
  </div>
</div>

<!-- LOCATION BANNER -->
<div class="loc-banner" id="locBanner">
  <div class="loc-dot"></div>
  <span id="locMsg">Getting your location...</span>
</div>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" onclick="switchTab('checkin',this)">‚úÖ Check In</button>
  <button class="tab"        onclick="switchTab('attendance',this)">üìã My Attendance</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê CHECK IN SECTION ‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-checkin" class="section active">

  <!-- Employee Info -->
  <div class="card">
    <div class="card-head">
      <div class="card-ico ico-blue">üë§</div>
      <div class="card-head-text">
        <div class="title">Employee Details</div>
        <div class="subtitle">Fill in your information below</div>
      </div>
    </div>

    <div class="fg">
      <label>Date</label>
      <input id="fDate" class="fi ro" readonly>
    </div>
    <div class="fg">
      <label>Time</label>
      <input id="fTime" class="fi ro" readonly>
    </div>
    <div class="fg">
      <label>Employee Name <span class="req">*</span></label>
      <input id="empName" class="fi" type="text" placeholder="Enter your full name">
    </div>
    <div class="fg">
      <label>Site Details <span class="req">*</span></label>
      <input id="siteDetails" class="fi" type="text" placeholder="e.g. AMPIN : ICR / MCR / SWITCHYARD / WTG">
    </div>
    <div class="fg" style="margin-bottom:0">
      <label>No. of Labour <span class="opt">(optional)</span></label>
      <input id="numLabour" class="fi" type="number" min="0" placeholder="Enter count" oninput="toggleLabourPhoto()">
    </div>
  </div>

  <!-- Selfie -->
  <div class="card">
    <div class="card-head">
      <div class="card-ico ico-green">ü§≥</div>
      <div class="card-head-text">
        <div class="title">Selfie Photo</div>
        <div class="subtitle">Portrait ¬∑ Camera only ¬∑ No upload</div>
      </div>
    </div>
    <div class="cam-wrap" id="selfieWrap">
      <div class="cam-placeholder" id="selfiePH" onclick="startCam('selfie')">
        <div class="icon">üì∑</div>
        <div class="lbl">Tap to Open Camera</div>
        <div class="sub">Portrait orientation</div>
      </div>
      <div id="selfiePreview" style="display:none">
        <video id="selfieVid" class="vp" autoplay playsinline muted></video>
        <div class="cam-ctrl">
          <button class="cbtn cbtn-sw" onclick="switchCam('selfie')">üîÑ</button>
          <button class="cbtn cbtn-cap" onclick="capture('selfie')">üì∏ Capture</button>
          <button class="cbtn cbtn-ret" onclick="stopCam('selfie')">‚úï</button>
        </div>
      </div>
      <div class="photo-wrap" id="selfiePhoto" style="display:none">
        <img id="selfieImg" alt="Selfie">
        <div class="photo-badge">‚úì Captured</div>
        <div class="cam-ctrl">
          <div></div>
          <button class="cbtn cbtn-ret" onclick="retake('selfie')">üîÑ Retake</button>
          <div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Labour Photo (conditional) -->
  <div class="card" id="labourCard" style="display:none">
    <div class="card-head">
      <div class="card-ico ico-blue">üë∑</div>
      <div class="card-head-text">
        <div class="title">Labour Photo</div>
        <div class="subtitle">Landscape ¬∑ Group shot ¬∑ Camera only</div>
      </div>
    </div>
    <div class="cam-wrap" id="labourWrap">
      <div class="cam-placeholder" id="labourPH" onclick="startCam('labour')">
        <div class="icon">üì∏</div>
        <div class="lbl">Tap to Capture Labour Photo</div>
        <div class="sub">Landscape ‚Äî wide frame for groups</div>
      </div>
      <div id="labourPreview" style="display:none">
        <video id="labourVid" class="vl" autoplay playsinline muted></video>
        <div class="cam-ctrl">
          <button class="cbtn cbtn-sw" onclick="switchCam('labour')">üîÑ</button>
          <button class="cbtn cbtn-cap" onclick="capture('labour')">üì∏ Capture</button>
          <button class="cbtn cbtn-ret" onclick="stopCam('labour')">‚úï</button>
        </div>
      </div>
      <div class="photo-wrap" id="labourPhoto" style="display:none">
        <img id="labourImg" alt="Labour Photo">
        <div class="photo-badge">‚úì Captured</div>
        <div class="cam-ctrl">
          <div></div>
          <button class="cbtn cbtn-ret" onclick="retake('labour')">üîÑ Retake</button>
          <div></div>
        </div>
      </div>
    </div>
  </div>

  <button class="submit-btn" id="submitBtn" onclick="handleSubmit()">
    üöÄ Submit Attendance
  </button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MY ATTENDANCE SECTION ‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-attendance" class="section">
  <div class="fp-note">üîí Showing records for this device only</div>

  <!-- Scorecard -->
  <div class="card">
    <div class="card-head">
      <div class="card-ico ico-blue">üèÜ</div>
      <div class="card-head-text">
        <div class="title">Scorecard</div>
        <div class="subtitle">Your attendance at a glance</div>
      </div>
    </div>
    <div class="score-grid">
      <div class="sc"><div class="num p" id="sToday">-</div><div class="lbl">Today</div></div>
      <div class="sc"><div class="num n" id="sWeek">-</div><div class="lbl">This Week</div></div>
      <div class="sc"><div class="num n" id="sMonth">-</div><div class="lbl">This Month</div></div>
    </div>
  </div>

  <!-- Log -->
  <div class="card">
    <div class="card-head">
      <div class="card-ico ico-green">üìä</div>
      <div class="card-head-text">
        <div class="title">Attendance Log</div>
        <div class="subtitle">Filter your records</div>
      </div>
    </div>
    <div class="filter-row">
      <button class="fbtn active" onclick="setFilter('week',this)">Weekly</button>
      <button class="fbtn"        onclick="setFilter('month',this)">Monthly</button>
      <button class="fbtn"        onclick="setFilter('custom',this)">Custom</button>
    </div>
    <div class="crange" id="crange">
      <input type="date" id="cFrom">
      <span style="color:var(--text-soft);font-size:13px">‚Üí</span>
      <input type="date" id="cTo">
      <button onclick="loadAttendance()">Go</button>
    </div>
    <div id="attLog">
      <div class="empty"><div class="ei">‚è≥</div><p>Loading records...</p></div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="overlay" id="modal">
  <div class="modal">
    <div class="m-icon">üéâ</div>
    <div class="m-title">Attendance Submitted!</div>
    <div id="mBody"></div>
    <button class="m-close" onclick="closeModal()">Done ‚úì</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>
<canvas id="cvs" style="display:none"></canvas>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CFG = {
  SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzPlYGAIvMhjaQvUFKxC9yG_1DLEVHLsD3lGKYjNfP4k6Vtrn1GgjfwsbpLzi4eYw03dg/exec'
};

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let selfieBlob = null, labourBlob = null;
let selfieStream = null, labourStream = null;
let selfieFace = 'user', labourFace = 'environment';
let currentFilter = 'week';
let deviceFP = '';

// Location state ‚Äî captured EARLY on load
let gpsLat = '', gpsLng = '', gpsAddress = '';
let locReady = false;

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  tickClock();
  setInterval(tickClock, 1000);
  deviceFP = fingerprint();
  setDefaultDates();
  captureLocationNow();   // ‚Üê grab location immediately on page load
});

function tickClock() {
  const n = new Date();
  document.getElementById('liveDate').textContent =
    n.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
  document.getElementById('liveTime').textContent =
    n.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
  document.getElementById('fDate').value =
    n.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
  document.getElementById('fTime').value =
    n.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
}

function fingerprint() {
  const s = [navigator.userAgent, navigator.language, screen.width, screen.height, new Date().getTimezoneOffset()].join('|');
  let h = 0;
  for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h |= 0; }
  return Math.abs(h).toString(36);
}

// ‚îÄ‚îÄ‚îÄ LOCATION ‚Äî captured on page load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function captureLocationNow() {
  const banner = document.getElementById('locBanner');
  const msg    = document.getElementById('locMsg');

  banner.className = 'loc-banner';
  msg.textContent  = 'Getting your location...';

  if (!navigator.geolocation) {
    banner.className = 'loc-banner err';
    msg.textContent  = 'Geolocation not supported on this device';
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      gpsLat  = pos.coords.latitude.toFixed(6);
      gpsLng  = pos.coords.longitude.toFixed(6);
      locReady = true;

      // Show coordinates immediately, then get address
      banner.className = 'loc-banner ok';
      msg.textContent  = `üìç ${gpsLat}, ${gpsLng} ‚Äî fetching address...`;

      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${gpsLat}&lon=${gpsLng}&format=json`);
        const d = await r.json();
        gpsAddress = d.display_name || `${gpsLat}, ${gpsLng}`;
        msg.textContent = 'üìç ' + gpsAddress.substring(0, 80) + (gpsAddress.length > 80 ? '‚Ä¶' : '');
      } catch {
        gpsAddress = `${gpsLat}, ${gpsLng}`;
        msg.textContent = `üìç ${gpsLat}, ${gpsLng}`;
      }
    },
    (err) => {
      banner.className = 'loc-banner err';
      msg.textContent  = '‚ö† Location denied ‚Äî will still save coordinates as blank';
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
  );
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(id, btn) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  btn.classList.add('active');
  if (id === 'attendance') loadAttendance();
}

// ‚îÄ‚îÄ‚îÄ LABOUR PHOTO TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleLabourPhoto() {
  const v = document.getElementById('numLabour').value;
  document.getElementById('labourCard').style.display =
    (v && parseInt(v) > 0) ? 'block' : 'none';
}

// ‚îÄ‚îÄ‚îÄ CAMERA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startCam(t) {
  const face = t === 'selfie' ? selfieFace : labourFace;
  const portrait = t === 'selfie';
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: face,
        width:  { ideal: portrait ? 720  : 1280 },
        height: { ideal: portrait ? 1280 : 720  }
      }
    });
    if (t === 'selfie') { selfieStream = stream; document.getElementById('selfieVid').srcObject = stream; }
    else                { labourStream = stream; document.getElementById('labourVid').srcObject = stream; }
    document.getElementById(t+'PH').style.display      = 'none';
    document.getElementById(t+'Preview').style.display = 'block';
    document.getElementById(t+'Wrap').classList.add('live');
  } catch {
    toast('Camera access denied ‚Äî please allow camera permission');
  }
}

function switchCam(t) {
  if (t === 'selfie') selfieFace = selfieFace === 'user' ? 'environment' : 'user';
  else                labourFace = labourFace === 'user' ? 'environment' : 'user';
  stopCam(t);
  setTimeout(() => startCam(t), 300);
}

function stopCam(t) {
  const s = t === 'selfie' ? selfieStream : labourStream;
  if (s) s.getTracks().forEach(tr => tr.stop());
  if (t === 'selfie') selfieStream = null; else labourStream = null;
  document.getElementById(t+'Preview').style.display = 'none';
  document.getElementById(t+'PH').style.display      = 'flex';
  document.getElementById(t+'Wrap').classList.remove('live');
}

function capture(t) {
  const vid = document.getElementById(t + 'Vid');
  const cvs = document.getElementById('cvs');
  const p   = t === 'selfie';
  cvs.width = p ? 720 : 1280; cvs.height = p ? 1280 : 720;
  cvs.getContext('2d').drawImage(vid, 0, 0, cvs.width, cvs.height);
  cvs.toBlob(blob => {
    compress(blob, p ? 0.72 : 0.68, cvs.width, cvs.height, comp => {
      const url = URL.createObjectURL(comp);
      if (t === 'selfie') selfieBlob = comp; else labourBlob = comp;
      document.getElementById(t+'Img').src = url;
      document.getElementById(t+'Preview').style.display = 'none';
      document.getElementById(t+'Photo').style.display   = 'block';
      const s = t === 'selfie' ? selfieStream : labourStream;
      if (s) s.getTracks().forEach(tr => tr.stop());
      toast('Photo captured!');
    });
  }, 'image/jpeg', 0.92);
}

function compress(blob, q, mW, mH, cb) {
  const img = new Image(), url = URL.createObjectURL(blob);
  img.onload = () => {
    const c = document.createElement('canvas');
    let w = img.width, h = img.height;
    if (w > mW) { h = h * mW / w; w = mW; }
    if (h > mH) { w = w * mH / h; h = mH; }
    c.width = w; c.height = h;
    c.getContext('2d').drawImage(img, 0, 0, w, h);
    c.toBlob(cb, 'image/jpeg', q);
    URL.revokeObjectURL(url);
  };
  img.src = url;
}

function retake(t) {
  if (t === 'selfie') selfieBlob = null; else labourBlob = null;
  document.getElementById(t+'Photo').style.display = 'none';
  document.getElementById(t+'PH').style.display    = 'flex';
  document.getElementById(t+'Wrap').classList.remove('live');
}

// ‚îÄ‚îÄ‚îÄ BATTERY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getBattery() {
  try { const b = await navigator.getBattery(); return Math.round(b.level * 100) + '%'; }
  catch { return 'N/A'; }
}

// ‚îÄ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function handleSubmit() {
  const empName    = document.getElementById('empName').value.trim();
  const siteDetails= document.getElementById('siteDetails').value.trim();
  const numLabour  = document.getElementById('numLabour').value.trim();

  if (!empName)     { toast('‚ö† Employee Name is required'); document.getElementById('empName').focus(); return; }
  if (!siteDetails) { toast('‚ö† Site Details are required'); document.getElementById('siteDetails').focus(); return; }
  if (!selfieBlob)  { toast('‚ö† Please capture your Selfie first'); return; }
  if (numLabour && parseInt(numLabour) > 0 && !labourBlob) { toast('‚ö† Please capture Labour Photo'); return; }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spin"></div> Submitting...';

  // If location wasn't ready yet, try one more quick attempt
  if (!locReady) {
    try {
      await new Promise((res, rej) => {
        navigator.geolocation.getCurrentPosition(pos => {
          gpsLat = pos.coords.latitude.toFixed(6);
          gpsLng = pos.coords.longitude.toFixed(6);
          locReady = true;
          res();
        }, rej, { timeout: 8000 });
      });
    } catch { /* use blank */ }
  }

  const now      = new Date();
  const battery  = await getBattery();
  const dateStr  = now.toLocaleDateString('en-IN', { day:'2-digit', month:'2-digit', year:'numeric' }).replace(/\//g,'-');
  const timeStr  = now.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false }).replace(/:/g,'-');
  const selfieFN = `${empName.replace(/\s+/g,'_')}_${dateStr}_${timeStr}`;
  const labourFN = `${siteDetails.replace(/[^a-zA-Z0-9]/g,'_').substring(0,20)}_${dateStr}_${timeStr}`;

  const selfieB64 = await toB64(selfieBlob);
  const labourB64 = labourBlob ? await toB64(labourBlob) : '';

  const payload = {
    action: 'checkIn',
    date: document.getElementById('fDate').value,
    time: document.getElementById('fTime').value,
    empName, siteDetails, numLabour: numLabour || '0',
    lat: gpsLat, lng: gpsLng, address: gpsAddress,
    battery, deviceFingerprint: deviceFP,
    selfieFileName: selfieFN, labourFileName: labourFN,
    selfieBase64: selfieB64, labourBase64: labourB64
  };

  try {
    if (CFG.SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') throw new Error('demo');
    const res  = await fetch(CFG.SCRIPT_URL, { method:'POST', body: JSON.stringify(payload) });
    const data = await res.json();
    if (!data.success) throw new Error(data.message);
  } catch (err) {
    if (err.message !== 'demo') {
      toast('‚ùå Submission failed: ' + err.message);
      btn.disabled = false;
      btn.innerHTML = 'üöÄ Submit Attendance';
      return;
    }
    // demo mode ‚Äî fall through
  }

  showModal({ date: payload.date, time: payload.time, empName, siteDetails, numLabour: numLabour || '0' });
  resetForm();
  btn.disabled = false;
  btn.innerHTML = 'üöÄ Submit Attendance';
}

function toB64(blob) {
  return new Promise(res => {
    const r = new FileReader();
    r.onloadend = () => res(r.result.split(',')[1]);
    r.readAsDataURL(blob);
  });
}

function resetForm() {
  ['empName','siteDetails','numLabour'].forEach(id => document.getElementById(id).value = '');
  selfieBlob = null; labourBlob = null;
  retake('selfie'); retake('labour');
  document.getElementById('labourCard').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showModal(d) {
  const rows = [
    ['Date', d.date], ['Time', d.time],
    ['Employee', d.empName], ['Site', d.siteDetails], ['No. of Labour', d.numLabour]
  ];
  document.getElementById('mBody').innerHTML = rows.map(([l,v]) =>
    `<div class="m-row"><span class="lbl">${l}</span><span class="val">${v}</span></div>`
  ).join('');
  document.getElementById('modal').classList.add('show');
}
function closeModal() { document.getElementById('modal').classList.remove('show'); }

// ‚îÄ‚îÄ‚îÄ ATTENDANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setDefaultDates() {
  const t = new Date(), f = new Date(t);
  f.setDate(f.getDate() - 30);
  document.getElementById('cTo').value   = t.toISOString().split('T')[0];
  document.getElementById('cFrom').value = f.toISOString().split('T')[0];
}

function setFilter(type, btn) {
  currentFilter = type;
  document.querySelectorAll('.fbtn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('crange').className = 'crange' + (type === 'custom' ? ' show' : '');
  if (type !== 'custom') loadAttendance();
}

async function loadAttendance() {
  const log = document.getElementById('attLog');
  log.innerHTML = '<div class="empty"><div class="ei">‚è≥</div><p>Loading...</p></div>';

  if (CFG.SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
    ['sToday','sWeek','sMonth'].forEach(id => document.getElementById(id).textContent = '0');
    log.innerHTML = '<div class="empty"><div class="ei">‚öôÔ∏è</div><p>Connect Apps Script to view records</p></div>';
    return;
  }

  const today = new Date();
  let from, to = today.toISOString().split('T')[0];
  if (currentFilter === 'week')  { const f=new Date(today); f.setDate(f.getDate()-7);   from=f.toISOString().split('T')[0]; }
  if (currentFilter === 'month') { const f=new Date(today); f.setMonth(f.getMonth()-1); from=f.toISOString().split('T')[0]; }
  if (currentFilter === 'custom') { from = document.getElementById('cFrom').value; to = document.getElementById('cTo').value; }

  try {
    const res  = await fetch(`${CFG.SCRIPT_URL}?action=getAttendance&fingerprint=${deviceFP}&from=${from}&to=${to}`);
    const data = await res.json();
    renderLog(data.records || [], data.scores || {});
  } catch {
    log.innerHTML = '<div class="empty"><div class="ei">‚ùå</div><p>Failed to load. Check connection.</p></div>';
  }
}

// ‚îÄ‚îÄ‚îÄ DATE / TIME FORMATTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtDate(raw) {
  if (!raw) return '-';
  const s = String(raw).trim();
  if (/^\d{1,2}[\s\-][A-Za-z]{3}[\s\-]\d{4}$/.test(s)) return s.replace(/-/g,' ');
  if (s.includes('T') || /^\d{4}-\d{2}-\d{2}/.test(s)) {
    const d = new Date(s);
    if (!isNaN(d)) return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
  }
  const n = parseFloat(s);
  if (!isNaN(n) && n > 1000 && n < 60000) {
    const d = new Date(new Date(1899,11,30).getTime() + n*86400000);
    return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
  }
  return s;
}

function fmtTime(raw) {
  if (!raw) return '-';
  const s = String(raw).trim();
  if (/^\d{1,2}:\d{2}/.test(s)) return s.replace(/\s*(am|pm)$/i, m => ' '+m.trim().toUpperCase());
  if (s.includes('T')) {
    const d = new Date(s);
    if (!isNaN(d)) return d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
  }
  const n = parseFloat(s);
  if (!isNaN(n) && n >= 0 && n < 1) {
    const ts = Math.round(n*86400), hh=Math.floor(ts/3600), mm=Math.floor((ts%3600)/60);
    return `${String(hh%12||12).padStart(2,'0')}:${String(mm).padStart(2,'0')} ${hh>=12?'PM':'AM'}`;
  }
  if (!isNaN(n) && n > 1) {
    const d = new Date(new Date(1899,11,30).getTime() + n*86400000);
    if (!isNaN(d)) return d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
  }
  return s;
}

function renderLog(records, scores) {
  document.getElementById('sToday').textContent = scores.today || 0;
  document.getElementById('sWeek').textContent  = scores.week  || 0;
  document.getElementById('sMonth').textContent = scores.month || 0;

  const log = document.getElementById('attLog');
  if (!records.length) {
    log.innerHTML = '<div class="empty"><div class="ei">üì≠</div><p>No records found for this period</p></div>';
    return;
  }
  const rows = records.map(r => `
    <tr>
      <td>${fmtDate(r.date)}</td>
      <td>${fmtTime(r.time)}</td>
      <td>${r.site || '-'}</td>
      <td><span class="badge bp">Present</span></td>
      <td style="text-align:center">${r.labour || '0'}</td>
    </tr>`).join('');

  log.innerHTML = `
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>Date</th><th>Time</th><th>Site</th><th>Status</th><th>Labour</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
