<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Field Attendance System</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --blue-dark: #0a2540;
    --blue-mid: #1a4b8c;
    --blue-bright: #2563eb;
    --blue-light: #dbeafe;
    --green-dark: #065f46;
    --green-mid: #059669;
    --green-bright: #10b981;
    --green-light: #d1fae5;
    --white: #ffffff;
    --off-white: #f8fafc;
    --text-dark: #0f172a;
    --text-mid: #334155;
    --text-light: #64748b;
    --border: #e2e8f0;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 16px rgba(10,37,64,0.12);
    --shadow-lg: 0 12px 40px rgba(10,37,64,0.18);
    --radius: 16px;
    --radius-sm: 10px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--off-white);
    color: var(--text-dark);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* HEADER */
  .header {
    background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-mid) 60%, var(--blue-bright) 100%);
    padding: 18px 20px 28px;
    position: relative;
    overflow: hidden;
  }
  .header::before {
    content: '';
    position: absolute;
    top: -40px; right: -40px;
    width: 180px; height: 180px;
    background: rgba(16,185,129,0.15);
    border-radius: 50%;
  }
  .header::after {
    content: '';
    position: absolute;
    bottom: -30px; left: 30px;
    width: 120px; height: 120px;
    background: rgba(37,99,235,0.2);
    border-radius: 50%;
  }
  .header-inner {
    position: relative; z-index: 1;
    display: flex; align-items: center; gap: 14px;
  }
  .logo-circle {
    width: 48px; height: 48px;
    background: linear-gradient(135deg, var(--green-bright), var(--green-mid));
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    box-shadow: 0 4px 12px rgba(16,185,129,0.4);
    flex-shrink: 0;
  }
  .header-title { color: white; }
  .header-title h1 {
    font-family: 'Syne', sans-serif;
    font-size: 20px; font-weight: 800;
    letter-spacing: -0.3px;
    line-height: 1.2;
  }
  .header-title p { font-size: 12px; opacity: 0.7; margin-top: 2px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; }

  /* LIVE DATETIME BAR */
  .datetime-bar {
    background: rgba(255,255,255,0.08);
    border-top: 1px solid rgba(255,255,255,0.12);
    padding: 10px 20px;
    display: flex; gap: 16px;
    position: relative; z-index: 1;
  }
  .dt-item { display: flex; align-items: center; gap: 6px; color: white; font-size: 13px; font-weight: 700; }
  .dt-item span:first-child { font-size: 15px; }

  /* TAB NAV */
  .tab-nav {
    background: var(--white);
    display: flex;
    border-bottom: 2px solid var(--border);
    position: sticky; top: 0; z-index: 100;
    box-shadow: var(--shadow-sm);
  }
  .tab-btn {
    flex: 1; padding: 14px 8px;
    border: none; background: none;
    font-family: 'Nunito', sans-serif;
    font-size: 13px; font-weight: 700;
    color: var(--text-light);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    transition: all 0.2s;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
  }
  .tab-btn.active {
    color: var(--blue-bright);
    border-bottom-color: var(--blue-bright);
  }
  .tab-btn span { font-size: 16px; }

  /* SECTIONS */
  .section { display: none; padding: 20px 16px 100px; animation: fadeUp 0.3s ease; }
  .section.active { display: block; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* CARD */
  .card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
  }
  .card-header {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  .card-icon {
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .card-icon.blue { background: var(--blue-light); }
  .card-icon.green { background: var(--green-light); }
  .card-title { font-size: 15px; font-weight: 800; color: var(--text-dark); }
  .card-subtitle { font-size: 11px; color: var(--text-light); font-weight: 600; margin-top: 1px; }

  /* FORM */
  .form-group { margin-bottom: 14px; }
  .form-label {
    display: block;
    font-size: 12px; font-weight: 700;
    color: var(--text-mid);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .form-label .req { color: var(--blue-bright); margin-left: 3px; }
  .form-input {
    width: 100%;
    padding: 12px 14px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: 'Nunito', sans-serif;
    font-size: 14px; font-weight: 600;
    color: var(--text-dark);
    background: var(--off-white);
    transition: all 0.2s;
    outline: none;
  }
  .form-input:focus {
    border-color: var(--blue-bright);
    background: white;
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }
  .form-input.readonly {
    background: var(--blue-light);
    color: var(--blue-dark);
    border-color: transparent;
    cursor: default;
  }
  .form-hint { font-size: 11px; color: var(--text-light); margin-top: 4px; font-weight: 600; }

  /* CAMERA WIDGET */
  .camera-widget {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    position: relative;
    background: #f1f5f9;
    transition: border-color 0.2s;
  }
  .camera-widget.active-cam { border-color: var(--green-bright); border-style: solid; }
  .camera-placeholder {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 32px 20px;
    gap: 10px;
    cursor: pointer;
  }
  .cam-icon { font-size: 40px; }
  .cam-text { font-size: 13px; font-weight: 700; color: var(--text-mid); text-align: center; }
  .cam-sub { font-size: 11px; color: var(--text-light); font-weight: 600; }

  .camera-preview-area { position: relative; }
  video {
    width: 100%; display: block;
    background: #000;
  }
  .video-portrait { height: 320px; object-fit: cover; }
  .video-landscape { height: 220px; object-fit: cover; }

  .cam-controls {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 14px;
    background: rgba(10,37,64,0.85);
  }
  .cam-btn {
    padding: 8px 16px;
    border: none; border-radius: 8px;
    font-family: 'Nunito', sans-serif;
    font-size: 12px; font-weight: 700;
    cursor: pointer;
    transition: all 0.15s;
  }
  .cam-btn:active { transform: scale(0.96); }
  .cam-btn-capture {
    background: var(--green-bright); color: white;
    padding: 10px 24px; font-size: 13px;
    border-radius: 50px;
    box-shadow: 0 4px 12px rgba(16,185,129,0.4);
  }
  .cam-btn-switch { background: rgba(255,255,255,0.15); color: white; font-size: 16px; padding: 8px 12px; border-radius: 8px; }
  .cam-btn-retake { background: rgba(255,255,255,0.15); color: white; }

  .photo-preview { position: relative; }
  .photo-preview img { width: 100%; display: block; }
  .photo-badge {
    position: absolute; top: 8px; right: 8px;
    background: var(--green-bright); color: white;
    padding: 4px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 700;
  }

  /* SUBMIT BTN */
  .submit-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--blue-bright), var(--blue-mid));
    color: white;
    border: none;
    border-radius: var(--radius);
    font-family: 'Nunito', sans-serif;
    font-size: 16px; font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 6px 20px rgba(37,99,235,0.35);
    display: flex; align-items: center; justify-content: center; gap: 8px;
    letter-spacing: 0.3px;
  }
  .submit-btn:active { transform: scale(0.98); }
  .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
  .submit-btn.loading { background: var(--text-light); }

  /* ATTENDANCE TABLE */
  .score-grid {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 10px; margin-bottom: 16px;
  }
  .score-card {
    background: var(--white);
    border-radius: var(--radius-sm);
    padding: 14px 10px;
    text-align: center;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
  }
  .score-num {
    font-family: 'Syne', sans-serif;
    font-size: 28px; font-weight: 800;
    line-height: 1;
  }
  .score-num.present { color: var(--green-mid); }
  .score-num.absent { color: #ef4444; }
  .score-num.neutral { color: var(--blue-bright); }
  .score-label { font-size: 10px; font-weight: 700; color: var(--text-light); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

  .filter-row {
    display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap;
  }
  .filter-btn {
    padding: 7px 14px;
    border: 2px solid var(--border);
    border-radius: 50px;
    background: white;
    font-family: 'Nunito', sans-serif;
    font-size: 12px; font-weight: 700;
    color: var(--text-mid);
    cursor: pointer;
    transition: all 0.15s;
  }
  .filter-btn.active {
    background: var(--blue-bright); color: white; border-color: var(--blue-bright);
  }
  .custom-range { display: none; gap: 8px; align-items: center; width: 100%; margin-top: 4px; }
  .custom-range.show { display: flex; }
  .custom-range input { flex: 1; padding: 8px 10px; border: 2px solid var(--border); border-radius: 8px; font-family: 'Nunito', sans-serif; font-size: 12px; font-weight: 600; }

  .att-table-wrap { overflow-x: auto; border-radius: var(--radius-sm); border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th {
    background: linear-gradient(135deg, var(--blue-dark), var(--blue-mid));
    color: white; padding: 10px 12px;
    text-align: left; font-weight: 700; font-size: 11px;
    text-transform: uppercase; letter-spacing: 0.5px;
    white-space: nowrap;
  }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--off-white); }
  .badge {
    display: inline-flex; align-items: center;
    padding: 3px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 700;
  }
  .badge-present { background: var(--green-light); color: var(--green-dark); }
  .badge-absent { background: #fee2e2; color: #991b1b; }

  .empty-state {
    text-align: center; padding: 40px 20px;
    color: var(--text-light);
  }
  .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; font-weight: 600; }

  /* MODAL */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(10,37,64,0.6);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: none; align-items: center; justify-content: center;
    padding: 20px;
    animation: fadeIn 0.2s ease;
  }
  .modal-overlay.show { display: flex; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .modal {
    background: white;
    border-radius: 20px;
    padding: 28px 24px;
    max-width: 380px; width: 100%;
    box-shadow: var(--shadow-lg);
    animation: popIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
  }
  @keyframes popIn {
    from { opacity: 0; transform: scale(0.85); }
    to { opacity: 1; transform: scale(1); }
  }
  .modal-icon { font-size: 52px; text-align: center; margin-bottom: 8px; }
  .modal-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; text-align: center; color: var(--text-dark); margin-bottom: 16px; }
  .modal-detail { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .modal-detail:last-of-type { border-bottom: none; }
  .modal-detail .label { font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
  .modal-detail .value { font-size: 14px; font-weight: 700; color: var(--text-dark); text-align: right; max-width: 200px; }
  .modal-close {
    width: 100%; margin-top: 20px;
    padding: 13px;
    background: linear-gradient(135deg, var(--green-bright), var(--green-mid));
    color: white; border: none; border-radius: var(--radius-sm);
    font-family: 'Nunito', sans-serif; font-size: 15px; font-weight: 800;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(16,185,129,0.35);
  }

  /* LOADING SPINNER */
  .spinner {
    width: 20px; height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .toast {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    background: var(--blue-dark); color: white;
    padding: 10px 20px; border-radius: 50px;
    font-size: 13px; font-weight: 700;
    z-index: 999;
    opacity: 0; transition: opacity 0.3s;
    pointer-events: none; white-space: nowrap;
  }
  .toast.show { opacity: 1; }

  .location-status {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 14px;
    background: var(--blue-light);
    border-radius: var(--radius-sm);
    margin-top: 8px;
    font-size: 12px; font-weight: 700; color: var(--blue-dark);
  }
  .location-status.success { background: var(--green-light); color: var(--green-dark); }
  .location-status.error { background: #fee2e2; color: #991b1b; }
  .loc-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 1.5s infinite; flex-shrink: 0; }
  .location-status.success .loc-dot, .location-status.error .loc-dot { animation: none; }
  @keyframes pulse { 0%,100%{ opacity:1; } 50%{ opacity:0.3; } }

  /* ATTENDANCE FINGERPRINT NOTICE */
  .fp-notice {
    background: linear-gradient(135deg, var(--blue-light), var(--green-light));
    border: 1px solid var(--blue-bright);
    border-radius: var(--radius-sm);
    padding: 12px 14px;
    margin-bottom: 14px;
    font-size: 12px; font-weight: 700; color: var(--blue-dark);
    display: flex; align-items: center; gap: 8px;
  }

  /* RESPONSIVE */
  @media (max-width: 400px) {
    .score-grid { grid-template-columns: repeat(3, 1fr); }
    .score-num { font-size: 24px; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <div class="logo-circle">‚ö°</div>
    <div class="header-title">
      <h1>Field Attendance</h1>
      <p>Site Check-In System</p>
    </div>
  </div>
  <div class="datetime-bar">
    <div class="dt-item"><span>üìÖ</span><span id="liveDate">--</span></div>
    <div class="dt-item"><span>‚è∞</span><span id="liveTime">--</span></div>
  </div>
</div>

<!-- TAB NAV -->
<div class="tab-nav">
  <button class="tab-btn active" onclick="switchTab('checkin')"><span>‚úÖ</span> Check In</button>
  <button class="tab-btn" onclick="switchTab('attendance')"><span>üìã</span> My Attendance</button>
</div>

<!-- CHECK IN SECTION -->
<div id="tab-checkin" class="section active">

  <!-- Employee Info Card -->
  <div class="card">
    <div class="card-header">
      <div class="card-icon blue">üë§</div>
      <div>
        <div class="card-title">Employee Details</div>
        <div class="card-subtitle">Fill in your information</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Date <span class="req">‚óè</span></label>
      <input type="text" id="fieldDate" class="form-input readonly" readonly>
    </div>
    <div class="form-group">
      <label class="form-label">Time <span class="req">‚óè</span></label>
      <input type="text" id="fieldTime" class="form-input readonly" readonly>
    </div>
    <div class="form-group">
      <label class="form-label">Employee Name <span class="req">*</span></label>
      <input type="text" id="empName" class="form-input" placeholder="Enter your full name" required>
    </div>
    <div class="form-group">
      <label class="form-label">Site Details <span class="req">*</span></label>
      <input type="text" id="siteDetails" class="form-input" placeholder="e.g. AMPIN:ICR / MCR / SWITCHYARD / WTG" required>
    </div>
    <div class="form-group">
      <label class="form-label">Number of Labour <small style="font-weight:600; color:var(--text-light);">(Optional)</small></label>
      <input type="number" id="numLabour" class="form-input" placeholder="Enter count (if applicable)" min="0" oninput="toggleLabourPhoto()">
    </div>
  </div>

  <!-- Selfie Card -->
  <div class="card">
    <div class="card-header">
      <div class="card-icon green">ü§≥</div>
      <div>
        <div class="card-title">Selfie Photo</div>
        <div class="card-subtitle">Portrait mode ‚Ä¢ Camera only</div>
      </div>
    </div>
    <div class="camera-widget" id="selfieWidget">
      <div class="camera-placeholder" id="selfiePlaceholder" onclick="startCamera('selfie')">
        <div class="cam-icon">üì∑</div>
        <div class="cam-text">Tap to Open Camera</div>
        <div class="cam-sub">Portrait orientation</div>
      </div>
      <div class="camera-preview-area" id="selfiePreviewArea" style="display:none;">
        <video id="selfieVideo" class="video-portrait" autoplay playsinline muted></video>
        <div class="cam-controls">
          <button class="cam-btn cam-btn-switch" onclick="switchCamera('selfie')" title="Switch Camera">üîÑ</button>
          <button class="cam-btn cam-btn-capture" onclick="capturePhoto('selfie')">üì∏ Capture</button>
          <button class="cam-btn cam-btn-retake" onclick="stopCamera('selfie')">‚úï Close</button>
        </div>
      </div>
      <div class="photo-preview" id="selfiePhotoPreview" style="display:none;">
        <img id="selfiePhotoImg" alt="Selfie">
        <div class="photo-badge">‚úì Captured</div>
        <div class="cam-controls">
          <div></div>
          <button class="cam-btn cam-btn-retake" onclick="retakePhoto('selfie')">üîÑ Retake</button>
          <div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Labour Photo Card (conditional) -->
  <div class="card" id="labourPhotoCard" style="display:none;">
    <div class="card-header">
      <div class="card-icon blue">üë∑</div>
      <div>
        <div class="card-title">Labour Photo</div>
        <div class="card-subtitle">Landscape mode ‚Ä¢ Group capture</div>
      </div>
    </div>
    <div class="camera-widget" id="labourWidget">
      <div class="camera-placeholder" id="labourPlaceholder" onclick="startCamera('labour')">
        <div class="cam-icon">üì∏</div>
        <div class="cam-text">Tap to Capture Labour Photo</div>
        <div class="cam-sub">Landscape orientation ‚Ä¢ Wide angle for groups</div>
      </div>
      <div class="camera-preview-area" id="labourPreviewArea" style="display:none;">
        <video id="labourVideo" class="video-landscape" autoplay playsinline muted></video>
        <div class="cam-controls">
          <button class="cam-btn cam-btn-switch" onclick="switchCamera('labour')" title="Switch Camera">üîÑ</button>
          <button class="cam-btn cam-btn-capture" onclick="capturePhoto('labour')">üì∏ Capture</button>
          <button class="cam-btn cam-btn-retake" onclick="stopCamera('labour')">‚úï Close</button>
        </div>
      </div>
      <div class="photo-preview" id="labourPhotoPreview" style="display:none;">
        <img id="labourPhotoImg" alt="Labour Photo">
        <div class="photo-badge">‚úì Captured</div>
        <div class="cam-controls">
          <div></div>
          <button class="cam-btn cam-btn-retake" onclick="retakePhoto('labour')">üîÑ Retake</button>
          <div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Location Card -->
  <div class="card">
    <div class="card-header">
      <div class="card-icon green">üìç</div>
      <div>
        <div class="card-title">Location</div>
        <div class="card-subtitle">Auto-captured on submit</div>
      </div>
    </div>
    <div id="locationStatus" class="location-status">
      <div class="loc-dot"></div>
      <span>Location will be captured when you submit</span>
    </div>
  </div>

  <!-- Submit -->
  <button class="submit-btn" id="submitBtn" onclick="handleSubmit()">
    <span>üöÄ</span> Submit Attendance
  </button>
</div>

<!-- MY ATTENDANCE SECTION -->
<div id="tab-attendance" class="section">
  <div class="fp-notice">
    <span>üîí</span>
    <span>Showing records for this device only</span>
  </div>

  <!-- Scorecard -->
  <div class="card">
    <div class="card-header">
      <div class="card-icon blue">üèÜ</div>
      <div>
        <div class="card-title">Scorecard</div>
        <div class="card-subtitle">Your attendance overview</div>
      </div>
    </div>
    <div class="score-grid">
      <div class="score-card">
        <div class="score-num present" id="scoreToday">-</div>
        <div class="score-label">Today</div>
      </div>
      <div class="score-card">
        <div class="score-num neutral" id="scoreWeek">-</div>
        <div class="score-label">This Week</div>
      </div>
      <div class="score-card">
        <div class="score-num neutral" id="scoreMonth">-</div>
        <div class="score-label">This Month</div>
      </div>
    </div>
  </div>

  <!-- Filter -->
  <div class="card">
    <div class="card-header">
      <div class="card-icon green">üìä</div>
      <div>
        <div class="card-title">Attendance Log</div>
        <div class="card-subtitle">Filter and view records</div>
      </div>
    </div>
    <div class="filter-row">
      <button class="filter-btn active" onclick="filterAttendance('week',this)">Weekly</button>
      <button class="filter-btn" onclick="filterAttendance('month',this)">Monthly</button>
      <button class="filter-btn" onclick="filterAttendance('custom',this)">Custom</button>
    </div>
    <div class="custom-range" id="customRange">
      <input type="date" id="customFrom">
      <span style="font-weight:700;color:var(--text-light)">‚Üí</span>
      <input type="date" id="customTo">
      <button class="cam-btn" style="background:var(--blue-bright);color:white;padding:8px 14px;border-radius:8px;" onclick="loadAttendance()">Go</button>
    </div>
    <div id="attTableContainer">
      <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <p>Loading your records...</p>
      </div>
    </div>
  </div>
</div>

<!-- CONFIRMATION MODAL -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-icon">üéâ</div>
    <div class="modal-title">Attendance Submitted!</div>
    <div id="modalDetails"></div>
    <button class="modal-close" onclick="closeModal()">‚úÖ Done</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<canvas id="captureCanvas" style="display:none;"></canvas>

<script>
// ============================================================
// CONFIGURATION - Update these with your deployment values
// ============================================================
const CONFIG = {
  APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzwgLsZuPCV4tnc8znZtNCmKXfHQOQVFa6iF4bGznGzUXGag2h5T0iXzq1XjlhtSOU-Kg/exec', // Replace after deploying Apps Script
};

// ============================================================
// STATE
// ============================================================
let selfieBlob = null, labourBlob = null;
let selfieStream = null, labourStream = null;
let selfieFacingMode = 'user', labourFacingMode = 'environment';
let currentFilter = 'week';
let deviceFingerprint = '';

// ============================================================
// INIT
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  updateDateTime();
  setInterval(updateDateTime, 1000);
  deviceFingerprint = getFingerprint();
  setDefaultCustomDates();
});

function updateDateTime() {
  const now = new Date();
  document.getElementById('liveDate').textContent = now.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
  document.getElementById('liveTime').textContent = now.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12: true });
  document.getElementById('fieldDate').value = now.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
  document.getElementById('fieldTime').value = now.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12: true });
}

function getFingerprint() {
  const nav = window.navigator;
  const s = [nav.userAgent, nav.language, screen.width, screen.height, screen.colorDepth, new Date().getTimezoneOffset()].join('|');
  let hash = 0;
  for (let i = 0; i < s.length; i++) { hash = ((hash << 5) - hash) + s.charCodeAt(i); hash |= 0; }
  return Math.abs(hash).toString(36);
}

// ============================================================
// TABS
// ============================================================
function switchTab(tab) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  event.currentTarget.classList.add('active');
  if (tab === 'attendance') loadAttendance();
}

// ============================================================
// TOGGLE LABOUR PHOTO
// ============================================================
function toggleLabourPhoto() {
  const val = document.getElementById('numLabour').value;
  document.getElementById('labourPhotoCard').style.display = (val && parseInt(val) > 0) ? 'block' : 'none';
}

// ============================================================
// CAMERA
// ============================================================
async function startCamera(type) {
  const facing = type === 'selfie' ? selfieFacingMode : labourFacingMode;
  const constraints = {
    video: {
      facingMode: facing,
      width: type === 'selfie' ? { ideal: 720 } : { ideal: 1280 },
      height: type === 'selfie' ? { ideal: 1280 } : { ideal: 720 },
    }
  };
  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    if (type === 'selfie') { selfieStream = stream; document.getElementById('selfieVideo').srcObject = stream; }
    else { labourStream = stream; document.getElementById('labourVideo').srcObject = stream; }
    document.getElementById(type + 'Placeholder').style.display = 'none';
    document.getElementById(type + 'PreviewArea').style.display = 'block';
    document.getElementById(type + 'Widget').classList.add('active-cam');
  } catch (err) {
    showToast('Camera access denied. Please allow camera.');
  }
}

async function switchCamera(type) {
  if (type === 'selfie') selfieFacingMode = selfieFacingMode === 'user' ? 'environment' : 'user';
  else labourFacingMode = labourFacingMode === 'user' ? 'environment' : 'user';
  stopCamera(type);
  setTimeout(() => startCamera(type), 300);
}

function stopCamera(type) {
  const stream = type === 'selfie' ? selfieStream : labourStream;
  if (stream) stream.getTracks().forEach(t => t.stop());
  if (type === 'selfie') selfieStream = null; else labourStream = null;
  document.getElementById(type + 'PreviewArea').style.display = 'none';
  document.getElementById(type + 'Placeholder').style.display = 'flex';
  document.getElementById(type + 'Widget').classList.remove('active-cam');
}

function capturePhoto(type) {
  const video = document.getElementById(type + 'Video');
  const canvas = document.getElementById('captureCanvas');
  const isPortrait = type === 'selfie';
  const w = isPortrait ? 720 : 1280;
  const h = isPortrait ? 1280 : 720;
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);

  canvas.toBlob(blob => {
    compressImage(blob, type === 'selfie' ? 0.7 : 0.65, w, h, (compressed) => {
      const url = URL.createObjectURL(compressed);
      if (type === 'selfie') selfieBlob = compressed; else labourBlob = compressed;
      document.getElementById(type + 'PhotoImg').src = url;
      document.getElementById(type + 'PreviewArea').style.display = 'none';
      document.getElementById(type + 'PhotoPreview').style.display = 'block';
      const stream = type === 'selfie' ? selfieStream : labourStream;
      if (stream) stream.getTracks().forEach(t => t.stop());
      showToast('Photo captured!');
    });
  }, 'image/jpeg', 0.9);
}

function compressImage(blob, quality, maxW, maxH, callback) {
  const img = new Image();
  const url = URL.createObjectURL(blob);
  img.onload = () => {
    const canvas = document.createElement('canvas');
    let w = img.width, h = img.height;
    if (w > maxW) { h = h * maxW / w; w = maxW; }
    if (h > maxH) { w = w * maxH / h; h = maxH; }
    canvas.width = w; canvas.height = h;
    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
    canvas.toBlob(callback, 'image/jpeg', quality);
    URL.revokeObjectURL(url);
  };
  img.src = url;
}

function retakePhoto(type) {
  if (type === 'selfie') selfieBlob = null; else labourBlob = null;
  document.getElementById(type + 'PhotoPreview').style.display = 'none';
  document.getElementById(type + 'Placeholder').style.display = 'flex';
  document.getElementById(type + 'Widget').classList.remove('active-cam');
}

// ============================================================
// GEOLOCATION
// ============================================================
function getLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) { reject('Geolocation not supported'); return; }
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      err => reject(err.message),
      { enableHighAccuracy: true, timeout: 15000 }
    );
  });
}

async function reverseGeocode(lat, lng) {
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
    const data = await res.json();
    return data.display_name || `${lat}, ${lng}`;
  } catch { return `${lat}, ${lng}`; }
}

// ============================================================
// BATTERY
// ============================================================
async function getBattery() {
  try {
    const b = await navigator.getBattery();
    return Math.round(b.level * 100) + '%';
  } catch { return 'N/A'; }
}

// ============================================================
// SUBMIT
// ============================================================
async function handleSubmit() {
  const empName = document.getElementById('empName').value.trim();
  const siteDetails = document.getElementById('siteDetails').value.trim();
  const numLabour = document.getElementById('numLabour').value.trim();
  const now = new Date();

  // Validation
  if (!empName) { showToast('‚ö†Ô∏è Employee Name is required'); document.getElementById('empName').focus(); return; }
  if (!siteDetails) { showToast('‚ö†Ô∏è Site Details are required'); document.getElementById('siteDetails').focus(); return; }
  if (!selfieBlob) { showToast('‚ö†Ô∏è Please capture your selfie'); return; }
  if (numLabour && parseInt(numLabour) > 0 && !labourBlob) { showToast('‚ö†Ô∏è Please capture Labour Photo'); return; }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Submitting...';
  btn.classList.add('loading');

  // Location
  const locStatus = document.getElementById('locationStatus');
  locStatus.className = 'location-status';
  locStatus.innerHTML = '<div class="loc-dot"></div><span>Getting your location...</span>';

  let lat = '', lng = '', address = '';
  try {
    const pos = await getLocation();
    lat = pos.lat.toFixed(6); lng = pos.lng.toFixed(6);
    address = await reverseGeocode(lat, lng);
    locStatus.className = 'location-status success';
    locStatus.innerHTML = `<div class="loc-dot"></div><span>üìç ${address.substring(0,60)}...</span>`;
  } catch (e) {
    locStatus.className = 'location-status error';
    locStatus.innerHTML = `<div class="loc-dot"></div><span>Location unavailable: ${e}</span>`;
  }

  const battery = await getBattery();
  const dateStr = now.toLocaleDateString('en-IN', { day:'2-digit', month:'2-digit', year:'numeric' }).replace(/\//g, '-');
  const timeStr = now.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12: false }).replace(/:/g, '-');
  const selfieFileName = `${empName.replace(/\s+/g,'_')}_${dateStr}_${timeStr}`;
  const labourFileName = `${siteDetails.replace(/[^a-zA-Z0-9]/g,'_').substring(0,20)}_${dateStr}_${timeStr}`;

  // Convert blobs to base64
  const selfieBase64 = await blobToBase64(selfieBlob);
  const labourBase64 = labourBlob ? await blobToBase64(labourBlob) : '';

  const payload = {
    action: 'checkIn',
    date: now.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }),
    time: now.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12: true }),
    empName, siteDetails, numLabour: numLabour || '0',
    lat, lng, address, battery,
    deviceFingerprint,
    selfieFileName, labourFileName,
    selfieBase64, labourBase64
  };

  try {
    const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    const result = await response.json();

    if (result.success) {
      showConfirmation({ date: payload.date, time: payload.time, empName, siteDetails, numLabour: numLabour || '0' });
      resetForm();
    } else {
      showToast('‚ùå Submission failed: ' + (result.message || 'Unknown error'));
    }
  } catch (err) {
    // For demo/testing when no backend is connected
    if (CONFIG.APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
      showConfirmation({ date: payload.date, time: payload.time, empName, siteDetails, numLabour: numLabour || '0' });
      resetForm();
    } else {
      showToast('‚ùå Network error. Check connection.');
    }
  }

  btn.disabled = false;
  btn.innerHTML = '<span>üöÄ</span> Submit Attendance';
  btn.classList.remove('loading');
}

function blobToBase64(blob) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(blob);
  });
}

function resetForm() {
  document.getElementById('empName').value = '';
  document.getElementById('siteDetails').value = '';
  document.getElementById('numLabour').value = '';
  selfieBlob = null; labourBlob = null;
  retakePhoto('selfie'); retakePhoto('labour');
  document.getElementById('labourPhotoCard').style.display = 'none';
}

// ============================================================
// MODAL
// ============================================================
function showConfirmation(data) {
  const details = [
    { label: 'Date', value: data.date },
    { label: 'Time', value: data.time },
    { label: 'Employee', value: data.empName },
    { label: 'Site', value: data.siteDetails },
    { label: 'No. of Labour', value: data.numLabour || '0' },
  ];
  document.getElementById('modalDetails').innerHTML = details.map(d =>
    `<div class="modal-detail"><span class="label">${d.label}</span><span class="value">${d.value}</span></div>`
  ).join('');
  document.getElementById('confirmModal').classList.add('show');
}

function closeModal() { document.getElementById('confirmModal').classList.remove('show'); }

// ============================================================
// ATTENDANCE VIEW
// ============================================================
function setDefaultCustomDates() {
  const today = new Date();
  const from = new Date(today); from.setDate(from.getDate() - 30);
  document.getElementById('customTo').value = today.toISOString().split('T')[0];
  document.getElementById('customFrom').value = from.toISOString().split('T')[0];
}

function filterAttendance(type, btn) {
  currentFilter = type;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('customRange').className = 'custom-range' + (type === 'custom' ? ' show' : '');
  if (type !== 'custom') loadAttendance();
}

async function loadAttendance() {
  const container = document.getElementById('attTableContainer');
  container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚è≥</div><p>Loading records...</p></div>';

  if (CONFIG.APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚öôÔ∏è</div><p>Connect Apps Script to view records</p></div>';
    document.getElementById('scoreToday').textContent = '0';
    document.getElementById('scoreWeek').textContent = '0';
    document.getElementById('scoreMonth').textContent = '0';
    return;
  }

  const today = new Date();
  let fromDate, toDate = today.toISOString().split('T')[0];

  if (currentFilter === 'week') { const f = new Date(today); f.setDate(f.getDate() - 7); fromDate = f.toISOString().split('T')[0]; }
  else if (currentFilter === 'month') { const f = new Date(today); f.setMonth(f.getMonth() - 1); fromDate = f.toISOString().split('T')[0]; }
  else { fromDate = document.getElementById('customFrom').value; toDate = document.getElementById('customTo').value; }

  try {
    const url = `${CONFIG.APPS_SCRIPT_URL}?action=getAttendance&fingerprint=${deviceFingerprint}&from=${fromDate}&to=${toDate}`;
    const res = await fetch(url);
    const data = await res.json();
    renderAttendance(data.records || [], data.scores || {});
  } catch {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><p>Failed to load records</p></div>';
  }
}

function renderAttendance(records, scores) {
  document.getElementById('scoreToday').textContent = scores.today || 0;
  document.getElementById('scoreWeek').textContent = scores.week || 0;
  document.getElementById('scoreMonth').textContent = scores.month || 0;

  if (!records.length) {
    document.getElementById('attTableContainer').innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><p>No records found for this period</p></div>';
    return;
  }

  const rows = records.map(r => `
    <tr>
      <td>${r.date}</td>
      <td>${r.time || '-'}</td>
      <td>${r.site || '-'}</td>
      <td><span class="badge badge-present">Present</span></td>
      <td>${r.labour || '0'}</td>
    </tr>
  `).join('');

  document.getElementById('attTableContainer').innerHTML = `
    <div class="att-table-wrap">
      <table>
        <thead><tr><th>Date</th><th>Time</th><th>Site</th><th>Status</th><th>Labour</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}
</script>
</body>
</html>
